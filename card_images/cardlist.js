const server_card_list = [
    {
        "artist": "AnatoleSerial",
        "front_art": "anatoleserial-01/front.png",
        "back_art": "anatoleserial-01/back.png",
        "pulled": false
    },
    {
        "artist": "Arches",
        "front_art": "arches-01/front.png",
        "back_art": "arches-01/back.png",
        "pulled": false
    },
    {
        "artist": "Arsyn",
        "front_art": "arsyn-01/front.png",
        "back_art": "arsyn-01/back.png",
        "pulled": false
    },
    {
        "artist": "BorizArts",
        "front_art": "borizarts-01/front.png",
        "back_art": "borizarts-01/back.png",
        "pulled": false
    },
    {
        "artist": "corpshephard",
        "front_art": "corpshephard-01/front.png",
        "back_art": "corpshephard-01/back.png",
        "pulled": false
    },
    {
        "artist": "Danbooru",
        "front_art": "danboru-01/front.png",
        "back_art": "danboru-01/back.png",
        "pulled": false
    },
    {
        "artist": "Danbooru",
        "front_art": "danboru-02/front.png",
        "back_art": "danboru-02/back.png",
        "pulled": false
    },
    {
        "artist": "Danbooru",
        "front_art": "danboru-03/front.png",
        "back_art": "danboru-03/back.png",
        "pulled": false
    },
    {
        "artist": "Danbooru",
        "front_art": "danboru-04/front.png",
        "back_art": "danboru-04/back.png",
        "pulled": false
    },
    {
        "artist": "freefloatkaleid",
        "front_art": "freefloatkaleid-01/front.png",
        "back_art": "freefloatkaleid-01/back.png",
        "pulled": false
    },
    {
        "artist": "hakuoro",
        "front_art": "hakuoro-01/front.png",
        "back_art": "hakuoro-01/back.png",
        "pulled": false
    },
    {
        "artist": "Ikki",
        "front_art": "ikki-01/front.png",
        "back_art": "ikki-01/back.png",
        "pulled": false
    },
    {
        "artist": "Kal",
        "front_art": "kal-01/front.png",
        "back_art": "kal-01/back.png",
        "pulled": false
    },
    {
        "artist": "kazukuma",
        "front_art": "kazukuma-01/front.png",
        "back_art": "kazukuma-01/back.png",
        "pulled": false
    },
    {
        "artist": "Kinoko",
        "front_art": "kinoko-01/front.png",
        "back_art": "kinoko-01/back.png",
        "pulled": false
    },
    {
        "artist": "knewbi",
        "front_art": "knewbi-01/front.png",
        "back_art": "knewbi-01/back.png",
        "pulled": false
    },
    {
        "artist": "le_mod",
        "front_art": "le_mod-01/front.png",
        "back_art": "le_mod-01/back.png",
        "pulled": false
    },
    {
        "artist": "Licorine",
        "front_art": "licorine-01/front.png",
        "back_art": "licorine-01/back.png",
        "pulled": false
    },
    {
        "artist": "moh",
        "front_art": "moh-01/front.png",
        "back_art": "moh-01/back.png",
        "pulled": false
    },
    {
        "artist": "mofumofu",
        "front_art": "mohumohu-01/front.png",
        "back_art": "mohumohu-01/back.png",
        "pulled": false
    },
    {
        "artist": "Naufuru",
        "front_art": "naufuru-01/front.png",
        "back_art": "naufuru-01/back.png",
        "pulled": false
    },
    {
        "artist": "Rarusel",
        "front_art": "rarusel-01/front.png",
        "back_art": "rarusel-01/back.png",
        "pulled": false
    },
    {
        "artist": "Rarusel",
        "front_art": "rarusel-02/front.png",
        "back_art": "rarusel-02/back.png",
        "pulled": false
    },
    {
        "artist": "Rarusel",
        "front_art": "rarusel-03/front.png",
        "back_art": "rarusel-03/back.png",
        "pulled": false
    },
    {
        "artist": "Rarusel",
        "front_art": "rarusel-04/front.png",
        "back_art": "rarusel-04/back.png",
        "pulled": false
    },
    {
        "artist": "Rarusel",
        "front_art": "rarusel-05/front.png",
        "back_art": "rarusel-05/back.png",
        "pulled": false
    },
    {
        "artist": "Rarusel",
        "front_art": "rarusel-06/front.png",
        "back_art": "rarusel-06/back.png",
        "pulled": false
    },
    {
        "artist": "Ruanronan",
        "front_art": "ruanronan-01/front.png",
        "back_art": "ruanronan-01/back.png",
        "pulled": false
    },
    {
        "artist": "Sani",
        "front_art": "s4ni-01/front.png",
        "back_art": "s4ni-01/back.png",
        "pulled": false
    },
    {
        "artist": "Sani",
        "front_art": "s4ni-02/front.png",
        "back_art": "s4ni-02/back.png",
        "pulled": false
    },
    {
        "artist": "Sayi50",
        "front_art": "sayi50-01/front.png",
        "back_art": "sayi50-01/back.png",
        "pulled": false
    },
    {
        "artist": "Vinyl Shark",
        "front_art": "vinylshark-01/front.png",
        "back_art": "vinylshark-01/back.png",
        "pulled": false
    },
    {
        "artist": "yuntan",
        "front_art": "yuntan-01/front.png",
        "back_art": "yuntan-01/back.png",
        "pulled": false
    },
    {
        "artist": "Zeuxis",
        "front_art": "Zeuxis-01/front.jpg",
        "back_art": "Zeuxis-01/back.jpg",
        "pulled": false
    }
];

const remote_update_flag = "2024_05_30update01";
const remote_update_flag_name = "White Prinyan";
var big_red_reset_button_flag = false;
export function last_position_reset_required_query() {
    return big_red_reset_button_flag;
}
/* Please put used remote_update_flags below:
2024_05_27update01, 


 */


var persistent_card_list = [];
var persistent_card_list_length_longer_flag = false;

function set_localitem_bulk(){
    var pure_json_text = JSON.stringify(persistent_card_list);
    window.localStorage.setItem("persistent_card_list", pure_json_text);
    console.log("persistent card list built / rebuilt. String length: "+pure_json_text.length);
}

export function set_localitem_ext(external_card_list){
    var pure_json_text = JSON.stringify(external_card_list);
    window.localStorage.setItem("persistent_card_list", pure_json_text);
    console.log("persistent card list built / rebuilt. String length: "+pure_json_text.length);
}

function get_localitem_bulk(){
    var pure_json_text = window.localStorage.getItem("persistent_card_list");
    persistent_card_list = JSON.parse(pure_json_text);
    if(persistent_card_list == null) return null;
    console.log("persistent card list : "+persistent_card_list.length);
    return persistent_card_list;
}

function get_update_flag(){
    var previous_update_flag = window.localStorage.getItem(remote_update_flag_name)
    
    if(previous_update_flag == "" || previous_update_flag == null) {
        console.log("update flag not set yet");
        big_red_reset_button_flag = false;
        previous_update_flag = remote_update_flag;
        return set_update_flag();
    }
    
    if(previous_update_flag.localeCompare(remote_update_flag) == 0) {
        console.log("No update required.");
        return previous_update_flag;
    }
    else {
        console.log("Update required.");
        big_red_reset_button_flag = true;
    }
    
    return set_update_flag();
}

function set_update_flag(){    
    window.localStorage.setItem(remote_update_flag_name, remote_update_flag);
    return remote_update_flag;
}

export function card_list_initialization(reinitialization_flag = false) {
    //Try retrieving previous item, this method could be a reinitialization.
    if( get_localitem_bulk() == null) {
        console.log("initializing for the very first time.");
        return persistent_card_list = server_card_list;
    }
    if(persistent_card_list.length == 0) {
        console.log("no cards detected. Copying from server data.");
        return persistent_card_list = server_card_list;
    }
    reinitialization_flag = big_red_reset_button_flag;
    if(reinitialization_flag){
        console.log("WARNING! Re-initialization flag triggered! \
            ALL DATA will be synchronized to the server's data \
            and last position");
        set_localitem_ext(server_card_list);
        persistent_card_list = server_card_list;
        console.log("Re-initialization completed! All data \
            synchronized to the server's data.");
        reinitialization_flag = 0;
        return persistent_card_list;
    }
    if( check_card_list_integrity() ) {
        console.log("Card list integrity preserved (length-checked) \
        will continue to use old local data.");
    }
    else {
        console.log("Card List Integrity not preserved! \
        resetting localStorage to new server_card_list");
        reinitialization_flag = 1;
        set_localitem_ext(server_card_list);
        persistent_card_list = server_card_list;
    }
    return persistent_card_list;
}

function check_card_list_integrity() {
    if(server_card_list != persistent_card_list.length) {
        //Update priority: server_card_list, one-way sync, ADDITION ONLY.
        //Reinitialization can only be called by the server by updating the entire system.
        if(persistent_card_list.length > server_card_list.length){
            persistent_card_list_length_longer_flag = true;
            console.log("localStorage reports having more data than the source. \
                This is not normal, since we don't usually delete submissions. \
                Aborting operation with extreme prejudice. The program will use \
                the old data.")
                return true;
        }
        else persistent_card_list_length_longer_flag = false;
        
            //!! ASSUMPTIONS: server_card_list superset of persistent_card_list !!
        var temporary_array = []; var walkover_counter = 0;
        for(var i = 0; i < server_card_list.length; i++){
            //Checking if the entire entry is the same, if it's not, add to persistent_card_list
            var current_card = server_card_list[i];
            var current_persistent_card = persistent_card_list[i - walkover_counter];
            if(current_card.artist != current_persistent_card.artist 
            || current_card.front_art != current_persistent_card.front_art 
            || current_card.back_art != current_persistent_card.back_art )
            {
                temporary_array[i] = current_card;
                walkover_counter++;
            }
            else{
                //this will preserve the pulled status.
                temporary_array[i] = current_persistent_card;
            }
        }
        persistent_card_list = temporary_array;
        return true;
    }
    else 
    {
        //this is an extremely naive check but I suppose will cover most cases. Better use MD5 but eh.
        //TODO: hashcheck this thing.
        if( JSON.stringify(server_card_list).length === JSON.stringify(persistent_card_list).length )
            return true;
        else return false;
    }
}

export function save_current_data_to_localstorage(){
    set_localitem_bulk();
    window.localStorage.setItem("update_required", remote_update_flag);
}

/* Use localstorage to store this data because of the pulled property.
reasoning: https://blog.logrocket.com/storing-retrieving-javascript-objects-localstorage/
I got 10MB of storage (just need a few KB probs)
It's not a security nightmare
this is all security insensitive data

    Create mechanism, initialization.
        First init: download and write. writenew()
        Subsequent init request: ignore.
        re-initialization: download and overwrite.  {filename} exists? {removeall() -> writenew()}
        Create mechanism, data addition
            We don't start from 0 because The First Init was already run, but if we do, throw an exception.
                Exception: Expected a file from the first init, but file was not found / corrupted.
            Subsequent data addition, whole list update
                Check length > current collection's length
                    for every line
                    Check content by matching artist name == artist name
                    AND Check the front_art != front art file name in filename
                    AND Check back_art name !=  back art file name in filename
                        -> copy content from the new array up to the current position to a temporary list
                    -> copy content from the old array to in the current position to a temporary list
                Quit program (I assume there's no submission removal, for now)
    Read mechanism, data request
        export const cardlist = JSON.parse(filename)
    Update mechanism, data modification
    (the method should be bulk update instead of direct single element editing)
        direct access -> use array number to access the data.
    Deletion mechanism, bulk data update.

 */